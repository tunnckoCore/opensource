<p align="center">
  <img
    align="center"
    src="https://rawcdn.githack.com/tunnckoCore/opensource/820e49e8692e845205e50d5c5f5869d8313f4206/packages/glob-cache/logo.png"
  />
</p>

# glob-cache [![npm version][npmv-img]][npmv-url] [![License][license-img]][license-url] [![Libera Manifesto][libera-manifesto-img]][libera-manifesto-url]

> Caching layer (using `cacache`) for any file globbing solution (`glob`, `fast-glob`, `tiny-glob` and `globby`). Makes you Instant Fast‚Ñ¢ and allows you to hook into very specific & important part of the process

Please consider following this project's author, [Charlike Mike Reagent](https://github.com/tunnckoCore), and :star: the project to show your :heart: and support.

<div id="readme"></div>

[![Code style][codestyle-img]][codestyle-url]
[![CircleCI linux build][linuxbuild-img]][linuxbuild-url]
[![CodeCov coverage status][codecoverage-img]][codecoverage-url]
[![Renovate App Status][renovateapp-img]][renovateapp-url]
[![Make A Pull Request][prs-welcome-img]][prs-welcome-url]
[![Time Since Last Commit][last-commit-img]][last-commit-url]

<!-- [![Semantically Released][standard-release-img]][standard-release-url] -->

If you have any _how-to_ kind of questions, please read the [Contributing Guide][contributing-url] and [Code of Conduct][code_of_conduct-url] documents.
For bugs reports and feature requests, [please create an issue][open-issue-url] or ping
[@tunnckoCore](https://twitter.com/tunnckoCore) at Twitter.

[![Conventional Commits][ccommits-img]][ccommits-url]
[![Minimum Required Nodejs][nodejs-img]][npmv-url]
[![NPM Downloads Monthly][downloads-monthly-img]][npmv-url]
[![NPM Downloads Total][downloads-total-img]][npmv-url]
[![Share Love Tweet][twitter-share-img]][twitter-share-url]
[![Twitter][twitter-img]][twitter-url]

Project is [semantically](https://semver.org) versioned & automatically released from [GitHub Actions](https://github.com/features/actions) with [Lerna](https://github.com/lerna/lerna).

[![Become a Patron][patreon-img]][patreon-url]
[![Buy me a Kofi][kofi-img]][kofi-url]
[![PayPal Donation][paypal-img]][paypal-url]
[![Bitcoin Coinbase][bitcoin-img]][bitcoin-url]
[![Keybase PGP][keybase-img]][keybase-url]

| Topic                                                            |                                           Contact |
| :--------------------------------------------------------------- | ------------------------------------------------: |
| Any legal or licensing questions, like private or commerical use |           ![tunnckocore_legal][tunnckocore_legal] |
| For any critical problems and security reports                   |     ![tunnckocore_security][tunnckocore_security] |
| Consulting, professional support, personal or team training      | ![tunnckocore_consulting][tunnckocore_consulting] |
| For any questions about Open Source, partnerships and sponsoring | ![tunnckocore_opensource][tunnckocore_opensource] |

<!-- Logo when needed:

<p align="center">
  <a href="https://github.com/tunnckoCore/opensource">
    <img src="./media/logo.png" width="85%">
  </a>
</p>

-->

<!-- highlights -->

## Table of Contents

- [Install](#install)
- [API](#api)
  - [globCache](#globcache)
- [Context and how it works](#context-and-how-it-works)
- [Contributing](#contributing)
  - [Guides and Community](#guides-and-community)
  - [Support the project](#support-the-project)
  - [OPEN Open Source](#open-open-source)
  - [Wonderful Contributors](#wonderful-contributors)
- [License](#license)

_(TOC generated by [verb](https://github.com/verbose/verb) using [markdown-toc](https://github.com/jonschlinkert/markdown-toc))_

## Install

This project requires [**Node.js**](https://nodejs.org) **>=10.18** _(see [Support & Release Policy](https://github.com/tunnckoCoreLabs/support-release-policy))_. Install it using
[**yarn**](https://yarnpkg.com) or [**npm**](https://npmjs.com).<br>
_We highly recommend to use Yarn when you think to contribute to this project._

```bash
$ yarn add glob-cache
```

<!-- docks-start -->

## API

_Generated using [jest-runner-docs](https://ghub.now.sh/jest-runner-docs)._

### [globCache](./src/index.js#L48)

Match files and folders using glob patterns. Returns a resolved Promise containing
a `{ results, cacache }` object - where `results` is an array of [Context](#context-and-how-it-works) objects
and `cacache` is the [cacache][] package.

**Signature**

```ts
function(options)
```

**Params**

- `options.include` **{Array&lt;string&gt;}** - string or array of string glob patterns
- `options.exclude` **{string}** - ignore patterns
- `options.always` **{boolean}** - a boolean that makes `options.hook` to always be called
- `options.hook` **{Function}** - a hook function passed with [Context](#context-and-how-it-works)
- `options.glob` **{Function}** - a globbing library like [glob][], [globby][], [fast-glob][], [tiny-glob][], defaults to `fast-glob`
- `options.globOptions` **{object}** - options passed to the `options.glob` library
- `options.cacheLocation` **{string}** - a filepath location of the cache, defaults to `./.cache/glob-cache`
- `returns` **{Promise}**

**Example**

```js
const tinyGlob = require('tiny-glob');
const glob = require('glob-cache');

glob({ include: 'src/*.js', glob: tinyGlob }).then(({ results }) => {
  console.log(results);
});
```

<!-- docks-end -->

## Context and how it works

Each context contains a `{ file, cacheFile, cacheLocation, cacache }` and more properties.
The `file` one represents the fresh file loaded from the system, the `cacheFile` represents the
file from the cache. Both has `path`, `size` and `integrity` properties, plus more.

The `cacheFile` can be `null` if it's the first hit (not found in cache),
in such case the `ctx.missing` will be `true` and on next runs this will be `false`.

Important to note is that `cacheFile` don't have a `contents` property, but has `path`
which points to the place of the cache file on the disk.

The interesting one is the `ctx.valid`. This one is the reason for the whole existance
of this module. If both the "source" file and cache file are the same,
e.g. same size and integrity (which means the contents/shasum are equal),
then `ctx.valid: true`, otherwise this will be `false`. Simply said, when you change your file(s)
matched by a the given glob pattern(s), then it will be `valid: false` and the `options.hook` will
be called.

There is also one more key point, and it's in the `options`. We have `options.hook` and
`options.always`. By default we only call the `options.hook` when `valid: false` which is
important and intentional, because most of the time you only want to do or run something
when there are actual changes in the files, right? But there are also a cases when you want
more control, that's why we have `options.always` option which bypass the previous validation
and so the `options.hook` will always be called and so you can decide what to do or
make more additional checks - for example, listen the `mtime` - or track the dependencies
of the file. Tracking dependencies is something that some test runner may benefit.

Because all that, we also expose `cacache` to that `options.hook`,
so you can update or clean the cache - it's up to you.

Example `results` array with context (which is also passed to `options.hook`):

```
[
  {
    file: {
      path: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/test/index.js',
      contents: <Buffer 27 75 73 65 20 73 74 72 69 63 74 27 3b 0a 0a 63 6f 6e 73 74 20 70 61 74 68 20 3d 20 72 65 71 75 69 72 65 28 27 70 61 74 68 27 29 3b 0a 63 6f 6e 73 74 ... 350 more bytes>,
      size: 400,
      integrity: 'sha512-p5daDYwu9vhNNjT9vfRrWHXIwwlPxeqeub4gs3qMZ88J//ONUH7Je2Muu9o+MxjA1Fv3xwbgkBdjcHgdj7ar4A=='
    },
    cacheFile: null,
    cacheLocation: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/test/fixture-cache',
    cacache: { /* cacache instance */ },
    valid: true,
    missing: true
  },
  {
    file: {
      path: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/src/index.js',
      contents: <Buffer 2f 2a 20 65 73 6c 69 6e 74 2d 64 69 73 61 62 6c 65 20 6e 6f 2d 70 61 72 61 6d 2d 72 65 61 73 73 69 67 6e 20 2a 2f 0a 0a 27 75 73 65 20 73 74 72 69 63 ... 5268 more bytes>,
      size: 5318,
      integrity: 'sha512-946V9t8jWq6oGdAVnrl206b077+Ejl0VFn/MK1axZdsFyvzGrT+MfzH2aVQOUPMcp8jm5tZvES7A1XXEsRvZ9w=='
    },
    cacheFile: null,
    cacheLocation: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/test/fixture-cache',
    cacache: { /* cacache instance */ },
    valid: true,
    missing: true
  }
]
```

And when you run it for the second time, the `cacheFile` won't be `null` anymore, like so

```
{
  file: {
    path: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/src/index.js',
    contents: <Buffer 2f 2a 20 65 73 6c 69 6e 74 2d 64 69 73 61 62 6c 65 20 6e 6f 2d 70 61 72 61 6d 2d 72 65 61 73 73 69 67 6e 20 2a 2f 0a 0a 27 75 73 65 20 73 74 72 69 63 ... 5268 more bytes>,
    size: 5318,
    integrity: 'sha512-946V9t8jWq6oGdAVnrl206b077+Ejl0VFn/MK1axZdsFyvzGrT+MfzH2aVQOUPMcp8jm5tZvES7A1XXEsRvZ9w=='
  },
  cacheFile: {
    key: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/src/index.js',
    integrity: 'sha512-946V9t8jWq6oGdAVnrl206b077+Ejl0VFn/MK1axZdsFyvzGrT+MfzH2aVQOUPMcp8jm5tZvES7A1XXEsRvZ9w==',
    path: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/test/fixture-cache/content-v2/sha512/78/84/a154130fdefee002a708cee1ae570db54b1a278fed9b7a3847c73b2545bd48947c2cd192d365f9d87653f098f80d98b4ee37923ba467dbc314acf0f42e39',
    size: 5318,
    time: 1579561781331,
    metadata: undefined
  },
  cacheLocation: '/home/charlike/github/tunnckoCore/opensource/packages/glob-cache/test/fixture-cache',
  cacache: { /* cacache instance */ },
  valid: true,
  missing: false
}
```

As you can see above, both the `file.integrity` and `cacheFile.integrity` are the same, also the `size`,
so the both files are equal (and so `valid: true`), and if you didn't put `always: true`, in this case the `hook` won't be called.

One more thing to clarify. When there is no cache, e.g. the state is "missing",
and if you look over the code you'll see that the `valid` is
hard-coded/forced to be `true`. You may expect the hook to be called in the first run
but it will not. For that behavior you should use the `always: true`.

In case you use the `options.always: true` option, you may need to have similar check in your `options.hook`:

```js
const JestWorker = require('jest-worker');

let worker = null;

(async () => {
  await globCache({
    async hook(ctx) {
      if (ctx.valid === false || (ctx.valid && ctx.missing)) {
        // If we are here, it's either the first run, or
        // only when there's a difference between the actual file and the cache file.
        // So we can, for example, call our worker/runner or whatever here.
        worker =
          worker ||
          new JestWorker(require.resolve('./my-awesome-worker-or-runner.js'), {
            numWorkers: 7,
            forkOptions: { stdio: 'inherit' },
          });

        await worker.default(ctx);
        await worker.end();
      }
    },
  });
})();
```

Above you're looking on a basic solution similar to what's done in Jest with the difference
that Jest can detect changes only if it's a Git project. At least the `--onlyChanged`
works that way (with Git requirement) - which isn't a big problem of course since mostly
every project is using Git, but anyway.

The point is, that you can do whatever you want in custom conditions based on your preferences and needs.

In above example you may wonder why we are instatiating JestWorker inside the `if` statement.
That's because if you instantiate it before the call of `globCache` (where is the `let worker` assignment)
then you have no way to end the worker in any meaningful and easy way.

Similar implementation you can see in the [`hela-eslint-workers`](https://github.com/tunnckoCore/opensource/tree/hela-eslint-workers/%40hela/eslint/src) branch
where using `glob-cache` we are trying to speed up ESLint a bit,
by putting `eslint.executeOnFiles` or `eslint.executeOnText` inside a worker.
The thing is that it doesn't help much, because ESLint is just slow - for the same reason
even the `jest-runner-eslint` doesn't help much with performance. I'm not saying that just to hate.
It's just because of the synchornous design of ESLint and the way it works. A big pain point is
not only that it exposes & uses only sync methods, but also the architecture of resolving huge amount
of configs and plugins. That may change if [RFC#9](https://github.com/eslint/rfcs/pull/9)
is accepted, for which I have big hopes. Even if it's accepted it will take few major releases.

**[back to top](#readme)**

## Contributing

### Guides and Community

Please read the [Contributing Guide][contributing-url] and [Code of Conduct][code_of_conduct-url] documents for advices.

For bug reports and feature requests, please join our [community][community-url] forum and open a thread there with prefixing the title of the thread with the name of the project if there's no separate channel for it.

Consider reading the [Support and Release Policy](https://github.com/tunnckoCoreLabs/support-release-policy) guide if you are interested in what are the supported Node.js versions and how we proceed. In short, we support latest two even-numbered Node.js release lines.

### Support the project

[Become a Partner or Sponsor?][patreon-url] :dollar: Check the **Partner**, **Sponsor** or **Omega-level** tiers! :tada: You can get your company logo, link & name on this file. It's also rendered on package page in [npmjs.com][npmv-url] and [yarnpkg.com](https://yarnpkg.com/en/package/glob-cache) sites too! :rocket:

Not financial support? Okey! [Pull requests](https://github.com/tunnckoCoreLabs/contributing#opening-a-pull-request), stars and all kind of [contributions](https://opensource.guide/how-to-contribute/#what-it-means-to-contribute) are always
welcome. :sparkles:

<!--
### OPEN Open Source

This project is following [OPEN Open Source](http://openopensource.org) model

> Individuals making significant and valuable contributions are given commit-access to the project to contribute as they see fit. This project is built on collective efforts and it's not strongly guarded by its founders.

There are a few basic ground-rules for its contributors

1. Any **significant modifications** must be subject to a pull request to get feedback from other contributors.
2. [Pull requests](https://github.com/tunnckoCoreLabs/contributing#opening-a-pull-request) to get feedback are _encouraged_ for any other trivial contributions, but are not required.
3. Contributors should attempt to adhere to the prevailing code-style and development workflow.
-->

### Wonderful Contributors

Thanks to the hard work of these wonderful people this project is alive! It follows the
[all-contributors](https://github.com/kentcdodds/all-contributors) specification.
Don't hesitate to add yourself to that list if you have made any contribution! ;) [See how,
here](https://github.com/jfmengels/all-contributors-cli#usage).

<!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section -->
<!-- prettier-ignore -->
| [<img src="https://avatars3.githubusercontent.com/u/5038030?v=4" width="120px;"/><br /><sub><b>Charlike Mike Reagent</b></sub>](https://tunnckocore.com)<br />[üíª](https://github.com/tunnckoCore/opensource/commits?author=tunnckoCore "Code") [üìñ](https://github.com/tunnckoCore/opensource/commits?author=tunnckoCore "Documentation") [üí¨](#question-tunnckoCore "Answering Questions") [üëÄ](#review-tunnckoCore "Reviewed Pull Requests") [üîç](#fundingFinding-tunnckoCore "Funding Finding") |
| :---: |

<!-- ALL-CONTRIBUTORS-LIST:END -->

Consider showing your [support](#support-the-project) to them. :sparkling_heart:

**[back to top](#readme)**

## License

Copyright (c) 2020-present, [Charlike Mike Reagent](https://tunnckocore.com) `<opensource@tunnckocore.com>` & [contributors](#wonderful-contributors).<br>
Released under the [(Parity-7.0.0 AND Prosperity-3.0.0) OR Patron-1.0.0 License][license-url].

[contributing-url]: https://github.com/tunnckoCore/opensource/blob/master/CONTRIBUTING.md
[code_of_conduct-url]: https://github.com/tunnckoCore/opensource/blob/master/CODE_OF_CONDUCT.md

<!-- Heading badges -->

[npmv-url]: https://www.npmjs.com/package/glob-cache
[npmv-img]: https://badgen.net/npm/v/glob-cache?icon=npm&cache=300
[license-url]: https://github.com/tunnckoCore/opensource/blob/master/packages/glob-cache/LICENSE
[license-img]: https://badgen.net/npm/license/glob-cache?cache=300
[libera-manifesto-url]: https://liberamanifesto.com
[libera-manifesto-img]: https://badgen.net/badge/libera/manifesto/grey

<!-- Front line badges -->

[codecoverage-img]: https://badgen.net/badge/coverage/100%25/green?icon=codecov&cache=300
[codecoverage-url]: https://codecov.io/gh/tunnckoCore/opensource
[codestyle-url]: https://github.com/airbnb/javascript
[codestyle-img]: https://badgen.net/badge/code%20style/airbnb/ff5a5f?icon=airbnb&cache=300
[linuxbuild-url]: https://github.com/tunnckocore/opensource/actions
[linuxbuild-img]: https://badgen.net/github/checks/tunnckoCore/opensource/master?cache=300&label=build&icon=github
[ccommits-url]: https://conventionalcommits.org/
[ccommits-img]: https://badgen.net/badge/conventional%20commits/v1.0.0/green?cache=300
[standard-release-url]: https://github.com/standard-release/standard-release
[standard-release-img]: https://badgen.net/badge/semantically/released/05c5ff?cache=300
[community-img]: https://badgen.net/badge/join/community/7b16ff?cache=300
[community-url]: https://github.com/tunnckocorehq/community
[last-commit-img]: https://badgen.net/github/last-commit/tunnckoCore/opensource/master?cache=300
[last-commit-url]: https://github.com/tunnckoCore/opensource/commits/master
[nodejs-img]: https://badgen.net/badge/node/>=10.18/green?cache=300
[downloads-weekly-img]: https://badgen.net/npm/dw/glob-cache?icon=npm&cache=300
[downloads-monthly-img]: https://badgen.net/npm/dm/glob-cache?icon=npm&cache=300
[downloads-total-img]: https://badgen.net/npm/dt/glob-cache?icon=npm&cache=300
[renovateapp-url]: https://renovatebot.com
[renovateapp-img]: https://badgen.net/badge/renovate/enabled/green?cache=300
[prs-welcome-img]: https://badgen.net/badge/PRs/welcome/green?cache=300
[prs-welcome-url]: http://makeapullrequest.com

<!-- TODO: update icon -->

[paypal-url]: https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=HYJJEZNSGAPGC&source=url
[paypal-img]: https://badgen.net/badge/PayPal/donate/003087?cache=300&icon=https://simpleicons.now.sh/paypal/fff

<!-- TODO: update icon -->

[kofi-url]: https://ko-fi.com/tunnckoCore
[kofi-img]: https://badgen.net/badge/Buy%20me/a%20coffee/29abe0c2?cache=300&icon=https://rawcdn.githack.com/tunnckoCore/badgen-icons/f8264c6414e0bec449dd86f2241d50a9b89a1203/icons/kofi.svg

<!-- TODO: update icon -->

[bitcoin-url]: https://www.blockchain.com/btc/payment_request?address=3QNHKun1K1SUui1b4Z3KEGPPsWC1TgtnqA&message=Open+Source+Software&amount_local=10&currency=USD
[bitcoin-img]: https://badgen.net/badge/Bitcoin%20tip/3QNHKun...b4Z3KEGPPsWC1TgtnqA/yellow?cache=300&icon=https://simpleicons.now.sh/bitcoin/fff
[keybase-url]: https://keybase.io/tunnckoCore
[keybase-img]: https://badgen.net/keybase/pgp/tunnckoCore?cache=300
[twitter-url]: https://twitter.com/tunnckoCore
[twitter-img]: https://badgen.net/twitter/follow/tunnckoCore?icon=twitter&color=1da1f2&cache=300
[patreon-url]: https://www.patreon.com/bePatron?u=5579781
[patreon-img]: https://badgen.net/badge/Become/a%20patron/F96854?icon=patreon

<!-- [patreon-img]: https://badgen.net/badge/Patreon/tunnckoCore/F96854?icon=patreon -->

[patreon-sponsor-img]: https://badgen.net/badge/become/a%20sponsor/F96854?icon=patreon
[twitter-share-url]: https://twitter.com/intent/tweet?text=https://github.com/tunnckoCore/opensource/tree/master&via=tunnckoCore
[twitter-share-img]: https://badgen.net/badge/twitter/share/1da1f2?icon=twitter
[open-issue-url]: https://github.com/tunnckoCore/opensource/issues/new
[tunnckocore_legal]: https://badgen.net/https/liam-badge-daknys6gadky.runkit.sh/com/legal/tunnckocore?label&color=A56016&icon=https://svgshare.com/i/Dt6.svg
[tunnckocore_consulting]: https://badgen.net/https/liam-badge-daknys6gadky.runkit.sh/com/consulting/tunnckocore?label&color=07ba96&icon=https://svgshare.com/i/Dt6.svg
[tunnckocore_security]: https://badgen.net/https/liam-badge-daknys6gadky.runkit.sh/com/security/tunnckocore?label&color=ed1848&icon=https://svgshare.com/i/Dt6.svg
[tunnckocore_opensource]: https://badgen.net/https/liam-badge-daknys6gadky.runkit.sh/com/opensource/tunnckocore?label&color=ff7a2f&icon=https://svgshare.com/i/Dt6.svg
[tunnckocore_newsletter]: https://badgen.net/https/liam-badge-daknys6gadky.runkit.sh/com/newsletter/tunnckocore?label&color=5199FF&icon=https://svgshare.com/i/Dt6.svg
[cacache]: https://github.com/npm/cacache
[fast-glob]: https://github.com/mrmlnc/fast-glob
[glob]: https://github.com/isaacs/node-glob
[globby]: https://github.com/sindresorhus/globby
[tiny-glob]: https://github.com/terkelg/tiny-glob
